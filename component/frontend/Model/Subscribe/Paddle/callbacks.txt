Notes on callbacks I need to create

PaymentRefunded -- Update subscription record
================================================================================
passthrough -- subscription ID
balance_gross_refund
balance_tax_refund
order_id -- payment_key
refund_type -- full, vat, partial (only cancel subscription on "full")

Actions depend on refund_type:

vat refund: zero out the tax rate and tax amount, add a note
partial refund: reduce the gross and tax amount, record net difference as discount, recalculate effective tax rate, add a note
full refund: cancel the subscription (status X) and set enabled to 0, add a note

I need to adjust the fee_amount as well

HighRiskTransactionCreated -- Update subscription record
================================================================================
passthrough -- subscription ID
case_id
risk_score
status	-- MUST be 'pending'

Set the payment status to 'P' (Pending).
Create a note "Transaction flagged as high risk on [DATE_TZ]. Case ID [CASE_ID], risk score [RISK_SCORE]%\n"

HighRiskTransactionUpdated -- Update subscription record
================================================================================
passthrough -- subscription ID
case_id
risk_score
status -- accepted OR rejected

IF status == 'accepted'
	Set payment status to 'C'
	Add note "High risk transaction cleared on [DATE_TZ]. Case ID [CASE_ID], risk score [RISK_SCORE]%\n"

IF status == 'rejected'
	Set payment status to 'X'
	Add note "High risk transaction rejected on [DATE_TZ]. Case ID [CASE_ID], risk score [RISK_SCORE]%\n"

PaymentDisputeCreated -- Update subscription record
================================================================================
passthrough -- subscription ID
status -- MUST be 'open'

Set payment_status to 'P' (Pending).
Create a note "Payment dispute opened on [DATE_TZ]. Subscription deactivated temporarily.%\n"

PaymentDisputeClosed -- Update subscription record
================================================================================
passthrough -- subscription ID
status -- MUST be 'closed'

If the payment_state is X or N do nothing; return.
If the payment_state is P or C set it to X and set enabled to 0.

TODO - Recurring callbacks

Javascript: add close handler, go through a special Message page which figures out if the subscription is paid, pending, canceled or new. Paid & pending: success page. Canceled & new: Cancel page.